name: Generate folder indexes and trigger FDP proxy

on:
  push:
    branches: [main]

permissions:
  contents: write
  pages: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Wait for GitHub Pages deployment
        run: |
          echo "Waiting 5 minutes for GitHub Pages to refresh..."
          sleep 300

      - name: Check last non-bot commit and POST if single .ttl in test/ folder (debug)
        run: |
          echo "Checking last non-bot commit (ignoring GitHub Actions commits)..."
          echo "-----------------------------------------"

          # Find last non-bot commit
          LAST_REAL_COMMIT=$(git log --no-merges --format="%H %an" | grep -v "github-actions\[bot\]" | head -n 1 | awk '{print $1}')
          echo "Last real commit SHA: $LAST_REAL_COMMIT"

          echo "DEBUG: Commit details:"
          git show --oneline --name-only $LAST_REAL_COMMIT || echo "Failed to show commit info"
          echo "-----------------------------------------"

          # List changed files
          LAST_COMMIT_FILES=$(git show --name-only --pretty="" $LAST_REAL_COMMIT)
          echo "Changed files in that commit:"
          echo "$LAST_COMMIT_FILES"
          echo "-----------------------------------------"

          COUNT=$(echo "$LAST_COMMIT_FILES" | grep -v '^$' | wc -l | tr -d ' ')
          echo "Total changed files: $COUNT"

          # Check if any are in the test folder
          TEST_FILES=$(echo "$LAST_COMMIT_FILES" | grep -E '^test/' || true)
          if [ -n "$TEST_FILES" ]; then
            echo "Commit affected 'test/' folder:"
            echo "$TEST_FILES"
          else
            echo "Commit did not affect 'test/' folder."
          fi
          echo "-----------------------------------------"

          echo "Current TTL files in test/:"
          ls -1 test/*.ttl 2>/dev/null || echo "No TTL files currently in test/"
          echo "-----------------------------------------"

          # If commit changed exactly one TTL file in test/
          if [ "$COUNT" -eq 1 ] && echo "$LAST_COMMIT_FILES" | grep -qE '^test/.+\.ttl$'; then
            FILE_PATH=$(echo "$LAST_COMMIT_FILES" | grep -E '^test/.+\.ttl$')
            FILE_NAME=$(basename "$FILE_PATH")
            echo "Single TTL file detected: $FILE_PATH"

            CLIENT_URL="https://ostrails.github.io/assessment-component-metadata-records/test/${FILE_NAME}"
            JSON_PAYLOAD=$(printf '{"clientUrl": "%s"}' "$CLIENT_URL")

            echo "CLIENT_URL: $CLIENT_URL"
            echo "JSON payload: $JSON_PAYLOAD"
            echo "-----------------------------------------"

            echo "Checking if file is available on GitHub Pages..."
            if curl --head --silent --fail "$CLIENT_URL" > /dev/null; then
              echo "File available on GitHub Pages. Sending POST request..."
              curl -v -L -H "content-type: application/json" \
                -d "$JSON_PAYLOAD" \
                https://tools.ostrails.eu/fdp-index-proxy/proxy
            else
              echo "File not yet reachable on GitHub Pages: $CLIENT_URL"
              echo "Skipping POST."
            fi
          else
            echo "Conditions not met for POST:"
            echo "   - Single file commit required (found $COUNT)"
            echo "   - File must be in test/ and end with .ttl"
          fi

      - name: Generate index.html files
        run: |
          python <<'EOF'
          from pathlib import Path

          folders = ["test", "metric", "benchmark", "algorithm"]

          for folder in folders:
              path = Path(folder)
              if not path.exists():
                  print(f"Skipping: folder '{folder}' not found.")
                  continue

              ttl_files = sorted([f.name for f in path.glob("*.ttl")])
              print(f"Found {len(ttl_files)} .ttl files in '{folder}': {ttl_files}")

              title = folder.capitalize() + " records"
              html = [
                  "<!DOCTYPE html>",
                  "<html>",
                  "<head>",
                  "  <meta charset='utf-8'>",
                  f"  <title>{title}</title>",
                  "</head>",
                  "<body>",
                  f"  <h1>{title}</h1>",
                  "  <ul>",
              ]
              for f in ttl_files:
                  html.append(f"    <li><a href='{f}'>{f}</a></li>")
              html += ["  </ul>", "</body>", "</html>"]

              index_path = path / "index.html"
              new_content = "\n".join(html)
              old_content = index_path.read_text(encoding="utf-8") if index_path.exists() else ""
              if new_content.strip() != old_content.strip():
                  index_path.write_text(new_content, encoding="utf-8")
                  print(f"Updated {folder}/index.html")
              else:
                  print(f"No change for {folder}/index.html")
          EOF

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add test/*.html metric/*.html benchmark/*.html algorithm/*.html || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Auto-update folder index.html files"
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} HEAD:${{ github.ref }}
          fi